<header class="header">
  <div class="brand">
    <div class="brand__logo">
      <iconify-icon icon="solar:wind-bold-duotone" width="22" height="22" aria-hidden="true"></iconify-icon>
    </div>
    <div class="brand__text">
      <h1>Meteológica</h1>
      <p>Predicción en tiempo real</p>
    </div>
  </div>

  <div class="header-actions">
    <!-- Switch Claro/Oscuro con Iconify -->
    <div class="theme-switch" aria-label="Cambiar tema">
      <input
        #themeToggle
        id="themeToggle"
        type="checkbox"
        class="theme-switch__input"
        [checked]="themeChoice==='dark'"
        (change)="setTheme(themeToggle.checked ? 'dark' : 'light')"
        aria-labelledby="themeSwitchLabel"
      />
      <label class="theme-switch__label" for="themeToggle">
        <iconify-icon class="theme-switch__icon" icon="ph:sun-duotone" width="16" height="16" aria-hidden="true"></iconify-icon>
        <span class="theme-switch__track">
          <span class="theme-switch__thumb"></span>
        </span>
        <span id="themeSwitchLabel" class="sr-only">Cambiar tema</span>
        <iconify-icon class="theme-switch__icon" icon="ph:moon-duotone" width="16" height="16" aria-hidden="true"></iconify-icon>
      </label>
    </div>

    <div class="status" role="status" aria-live="polite" aria-atomic="true" [class.active]="isStreaming">
      <span class="status-indicator"></span>
      <span>{{ isStreaming ? 'Actualizando datos en tiempo real' : 'Inicializando...' }}</span>
    </div>
  </div>
</header>

<main class="container">
  <!-- Controles -->
  <section class="toolbar card-surface">
    <div class="series-group" role="group" aria-label="Series">
      <span class="label">Series:</span>

      <label class="toggle">
        <input #tempChk type="checkbox" [checked]="showTemp" (change)="onTempCheckboxChange(tempChk.checked)">
        <span>
          <iconify-icon icon="ph:thermometer-duotone" width="16" height="16" aria-hidden="true"></iconify-icon>
          &nbsp;Temperatura
        </span>
      </label>

      <label class="toggle">
        <input #energyChk type="checkbox" [checked]="showEnergy" (change)="onEnergyCheckboxChange(energyChk.checked)">
        <span>
          <iconify-icon icon="ph:lightning-duotone" width="16" height="16" aria-hidden="true"></iconify-icon>
          &nbsp;Energía
        </span>
      </label>
    </div>
  </section>

  <!-- KPIs -->
  <section class="current-values card-surface">
    <div class="kpis-header">
      <h2 class="section-title">Indicadores</h2>
      <div class="microcopy">
        <span class="dot" [class.on]="isStreaming"></span>
        <span class="muted">Actualizado {{ lastUpdatedRel }}</span>
      </div>
    </div>

    @if (processedDisplay==='0') {
      <div class="skeletons">
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
      </div>
    } @else {
      <div class="cards">
        <!-- KPI Temperatura -->
        <div class="card kpi" role="group" aria-label="Temperatura media">
          <div class="kpi-head">
            <div class="kpi-title">
              <iconify-icon icon="ph:thermometer-duotone" width="18" height="18" aria-hidden="true"></iconify-icon>
              <span>Temperatura media</span>
            </div>
            <div class="kpi-trend" [class.up]="trendTemp==='up'" [class.down]="trendTemp==='down'">
              <iconify-icon
                [icon]="trendTemp==='up' ? 'ph:trend-up-duotone' : trendTemp==='down' ? 'ph:trend-down-duotone' : 'ph:minus-duotone'"
                width="16" height="16" aria-hidden="true"></iconify-icon>
              <span class="muted">{{ trendTemp==='flat' ? 'estable' : (trendTemp==='up' ? 'alza' : 'baja') }}</span>
            </div>
          </div>

          <div class="kpi-body">
            <div class="kpi-value"
                 [class.flash-on]="tempPulse"
                 [class.kpi-bounce]="tempPulse">
              {{ tempDisplay }}<span class="unit">°C</span>
            </div>
            <canvas #sparkTemp class="sparkline" aria-hidden="true"></canvas>
          </div>
        </div>

        <!-- KPI Energía -->
        <div class="card kpi" role="group" aria-label="Energía producida">
          <div class="kpi-head">
            <div class="kpi-title">
              <iconify-icon icon="ph:lightning-duotone" width="18" height="18" aria-hidden="true"></iconify-icon>
              <span>Energía producida</span>
            </div>
            <div class="kpi-trend"
                 [class.up]="trendEnergy==='up'"
                 [class.down]="trendEnergy==='down'">
              <iconify-icon
                [icon]="trendEnergy==='up' ? 'ph:trend-up-duotone' : trendEnergy==='down' ? 'ph:trend-down-duotone' : 'ph:minus-duotone'"
                width="16" height="16" aria-hidden="true"></iconify-icon>
              <span class="muted">{{ trendEnergy==='flat' ? 'estable' : (trendEnergy==='up' ? 'alza' : 'baja') }}</span>
            </div>
          </div>

          <div class="kpi-body">
            <div class="kpi-value"
                 [class.flash-on]="energyPulse"
                 [class.kpi-bounce]="energyPulse">
              {{ energyDisplay }}<span class="unit">kWh</span>
            </div>
            <canvas #sparkEnergy class="sparkline" aria-hidden="true"></canvas>
          </div>
        </div>
      </div>
    }
  </section>

  <!-- Gráficas -->
  <section class="charts">
    <div class="chart-container card-surface">
      <div class="section-title">Temperatura (°C)</div>
      <p id="tempChartDesc" class="sr-only">
        Gráfico de líneas de temperatura en grados Celsius.
        Ventana activa: {{ activeRangeLabel }}.
        Última actualización: {{ lastUpdatedRel }}.
      </p>
      <canvas
        #temperatureChart
        role="img"
        [attr.aria-label]="'Serie de temperatura en °C, ventana ' + activeRangeLabel"
        [attr.aria-describedby]="'tempChartDesc'">
      </canvas>
    </div>

    <div class="chart-container card-surface">
      <div class="section-title">Energía producida (kWh)</div>
      <p id="energyChartDesc" class="sr-only">
        Gráfico de líneas de energía producida en kilovatios-hora.
        Ventana activa: {{ activeRangeLabel }}.
        Última actualización: {{ lastUpdatedRel }}.
      </p>
      <canvas
        #energyChart
        role="img"
        [attr.aria-label]="'Serie de energía en kWh, ventana ' + activeRangeLabel"
        [attr.aria-describedby]="'energyChartDesc'">
      </canvas>
    </div>
  </section>

  <!-- Estadísticas -->
<section class="statistics card-surface">
  <div class="stats-header">
    <h2 class="section-title">Estadísticas</h2>
    <div class="muted">Ventana: {{ activeRangeLabel }}</div>
  </div>

  <div class="stats-grid">

    <div class="stat">
      <span class="stat-label">
        <iconify-icon icon="ph:database-duotone" width="16" height="16" aria-hidden="true"></iconify-icon>
        Datos procesados
      </span>
      <span class="stat-value">{{ processedDisplay }}</span>
    </div>

    <div class="stat">
      <span class="stat-label">
        <iconify-icon icon="ph:arrows-left-right-duotone" width="16" height="16"></iconify-icon>
        Cambio Temp. media
      </span>
      <span class="stat-value">
        <span class="delta"
              [class.up]="deltas.tempAvgPct > 0"
              [class.down]="deltas.tempAvgPct < 0"
              [attr.title]="'Cambio vs ventana anterior: ' + (deltas.tempAvgPct | number:'1.0-1') + '%'">
          {{ (deltas.tempAvgPct || 0) | number:'1.0-1' }}%
          <iconify-icon
            [icon]="deltas.tempAvgPct > 0 ? 'ph:arrow-up-right-duotone' : deltas.tempAvgPct < 0 ? 'ph:arrow-down-right-duotone' : 'ph:minus-duotone'"
            width="14" height="14"></iconify-icon>
        </span>
      </span>
    </div>

    <div class="stat">
      <span class="stat-label">
        <iconify-icon icon="ph:flame-duotone" width="16" height="16" aria-hidden="true"></iconify-icon>
        Máx. temperatura
      </span>
      <span class="stat-value">{{ stats.tempMax.toFixed(1) }} °C</span>
    </div>

    <div class="stat">
      <span class="stat-label">
        <iconify-icon icon="ph:lightning-duotone" width="16" height="16" aria-hidden="true"></iconify-icon>
        Energía acumulada
      </span>
      <span class="stat-value">{{ stats.energySum.toFixed(2) }} kWh</span>
    </div>

    <div class="stat">
      <span class="stat-label">
        <iconify-icon icon="ph:clock-duotone" width="16" height="16" aria-hidden="true"></iconify-icon>
        Intervalo de actualización
      </span>
      <span class="stat-value">5 s</span>
    </div>

    <div class="stat">
      <span class="stat-label">
        <iconify-icon icon="ph:hourglass-duotone" width="16" height="16" aria-hidden="true"></iconify-icon>
        Tiempo transcurrido
      </span>
      <span class="stat-value">{{ elapsedTime }}</span>
    </div>

    <div class="stat stat--with-progress">
      <span class="stat-label">
        <iconify-icon icon="ph:activity-duotone" width="16" height="16" aria-hidden="true"></iconify-icon>
        Progreso de la ventana
      </span>
      <span class="stat-value">{{ windowProgressPct }}%</span>
      <div class="progress">
        <div class="progress__bar" [style.width.%]="windowProgressPct"></div>
      </div>
    </div>

    <div class="stat">
      <span class="stat-label">
        <iconify-icon icon="ph:arrows-left-right-duotone" width="16" height="16" aria-hidden="true"></iconify-icon>
        Cambio Energía
      </span>
      <span class="stat-value">
        <span class="delta"
              [class.up]="deltas.energySumPct > 0"
              [class.down]="deltas.energySumPct < 0"
              [attr.title]="'Cambio vs ventana anterior: ' + (deltas.energySumPct|number:'1.0-1') + '%'">
          {{ (deltas.energySumPct || 0) | number:'1.0-1' }}%
          <iconify-icon
            [icon]="deltas.energySumPct > 0 ? 'ph:arrow-up-right-duotone' : deltas.energySumPct < 0 ? 'ph:arrow-down-right-duotone' : 'ph:minus-duotone'"
            width="14" height="14" aria-hidden="true"></iconify-icon>
        </span>
      </span>
    </div>

  </div>
</section>


  <!-- Resumen del periodo (sin donuts) -->
  <section class="summary-kpis card-surface" style="margin-top:16px;">
    <div class="kpis-header">
      <h2 class="section-title">Resumen del periodo</h2>
      <div class="muted">Ventana: {{ activeRangeLabel }}</div>
    </div>

    <div class="cards kpi-quad">
      <!-- 1) Pico de energía -->
      <div class="card kpi" role="group" aria-label="Pico de energía">
        <div class="kpi-head">
          <div class="kpi-title">
            <iconify-icon icon="ph:lightning-duotone" width="18" height="18" aria-hidden="true"></iconify-icon>
            <span>Pico de energía</span>
          </div>
        </div>
        <div class="kpi-body">
          <div class="kpi-value">{{ energyPeakKwh.toFixed(2) }}<span class="unit">kWh</span></div>
          <div class="muted">Hoy a las {{ energyPeakTime }}</div>
        </div>
      </div>

      <!-- 2) Temperatura media -->
      <div class="card kpi" role="group" aria-label="Temperatura media (ventana)">
        <div class="kpi-head">
          <div class="kpi-title">
            <iconify-icon icon="ph:thermometer-duotone" width="18" height="18" aria-hidden="true"></iconify-icon>
            <span>Temperatura media</span>
          </div>
        </div>
        <div class="kpi-body">
          <div class="kpi-value">{{ stats.tempAvg.toFixed(1) }}<span class="unit">°C</span></div>
          <div class="muted">Últimos {{ activeRangeLabel }}</div>
        </div>
      </div>

      <!-- 3) Variación térmica -->
      <div class="card kpi" role="group" aria-label="Variación térmica">
        <div class="kpi-head">
          <div class="kpi-title">
            <iconify-icon icon="ph:activity-duotone" width="18" height="18" aria-hidden="true"></iconify-icon>
            <span>Variación térmica</span>
          </div>
        </div>
        <div class="kpi-body">
          <div class="kpi-value">{{ tempVariationLabel.replace('.', ',') }}</div>
          <div class="muted">{{ tempStateLabel }}</div>
        </div>
      </div>

      <!-- 4) Energía acumulada -->
      <div class="card kpi" role="group" aria-label="Energía acumulada (ventana)">
        <div class="kpi-head">
          <div class="kpi-title">
            <iconify-icon icon="ph:battery-charging-duotone" width="18" height="18" aria-hidden="true"></iconify-icon>
            <span>Energía acumulada</span>
          </div>
        </div>
        <div class="kpi-body">
          <div class="kpi-value">{{ stats.energySum.toFixed(2) }}<span class="unit">kWh</span></div>
          <div class="muted">Últimos {{ activeRangeLabel }}</div>
        </div>
      </div>
    </div>
  </section>

</main>

<footer class="footer">
  <div class="footer-content">
    <p>© {{ currentYear }} Meteológica — Plataforma de análisis meteorológico en tiempo real</p>
    <p class="tech-info">Desarrollado con <strong>Angular 17</strong> · <strong>Chart.js</strong></p>
  </div>
</footer>
